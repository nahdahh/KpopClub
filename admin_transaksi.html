<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>KPOP CLUB - Admin: Transaction Management</title>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<!-- Custom CSS -->
<link rel="stylesheet" href="assets/css/styles.css">
<link rel="stylesheet" href="assets/css/admin.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block admin-sidebar p-0">
            <div class="p-3 text-center">
                <a href="admin_dashboard.html" class="text-decoration-none">
                    <h4 class="y2k-title">KPOP <span>CLUB</span></h4>
                    <p class="small text-muted">Admin Panel</p>
                </a>
            </div>
            <hr>
            <ul class="nav flex-column p-3">
                <li class="nav-item">
                    <a class="nav-link" href="admin_dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin_product.html">
                        <i class="fas fa-box me-2"></i> Products
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin_articles.html">
                        <i class="fas fa-newspaper me-2"></i> Articles
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin_users.html">
                        <i class="fas fa-users me-2"></i> Users
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="admin_transaksi.html">
                        <i class="fas fa-money-bill-wave me-2"></i> Transactions
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="admin_setting.html">
                        <i class="fas fa-cog me-2"></i> Settings
                    </a>
                </li>
                <li class="nav-item mt-5">
                    <a class="nav-link text-danger" href="Landingpage.html" data-action="logout">
                        <i class="fas fa-sign-out-alt me-2"></i> Logout
                    </a>
                </li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 ms-sm-auto">
            <!-- Header -->
            <div class="admin-header-simple d-flex justify-content-between align-items-center px-3">
                <!-- Left: Hamburger Menu + Page Title -->
                <div class="d-flex align-items-center">
                    <button class="btn sidebar-toggle me-3" type="button" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h4 class="page-title mb-0">Transaction Management</h4>
                </div>
                
                <!-- Right: Notification + Profile (All aligned to right) -->
                <div class="d-flex align-items-center ms-auto">
                    <!-- Notification Bell -->
                    <div class="notification-wrapper me-3">
                        <button class="btn notification-btn position-relative" type="button">
                            <i class="fas fa-bell"></i>
                            <span class="notification-dot"></span>
                        </button>
                    </div>
                    
                    <!-- Profile Section -->
                    <div class="profile-section d-flex align-items-center">
                        <img id="admin-avatar" src="/placeholder.svg?height=40&width=40" alt="Admin" class="profile-avatar me-2">
                        <div class="profile-info">
                            <div id="admin-name" class="profile-name">Loading...</div>
                            <div id="admin-role" class="profile-role">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="admin-content p-3">
                <!-- Stats Cards -->
                <div class="row mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="stat-card bg-primary bg-opacity-10">
            <div class="icon bg-primary text-dark">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-value" id="total-orders">0</div>
            <div class="stat-label">Total Orders</div>
            <div class="progress mt-2">
                <div class="progress-bar bg-primary" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-success mt-2 d-block">
                <i class="fas fa-arrow-up"></i> 12% from last week
            </small>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card bg-success bg-opacity-10">
            <div class="icon bg-success text-dark">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-value" id="total-revenue">Rp 0</div>
            <div class="stat-label">Total Revenue</div>
            <div class="progress mt-2">
                <div class="progress-bar bg-success" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-success mt-2 d-block">
                <i class="fas fa-arrow-up"></i> 8% from last week
            </small>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card bg-warning bg-opacity-10">
            <div class="icon bg-warning text-dark">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" id="pending-orders">0</div>
            <div class="stat-label">Pending Orders</div>
            <div class="progress mt-2">
                <div class="progress-bar bg-warning" role="progressbar" style="width: 45%" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-info mt-2 d-block">
                <i class="fas fa-clock"></i> Awaiting payment
            </small>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="stat-card bg-info bg-opacity-10">
            <div class="icon bg-info text-dark">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value" id="completed-orders">0</div>
            <div class="stat-label">Completed Orders</div>
            <div class="progress mt-2">
                <div class="progress-bar bg-info" role="progressbar" style="width: 82%" aria-valuenow="82" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <small class="text-success mt-2 d-block">
                <i class="fas fa-arrow-up"></i> 5% from last week
            </small>
        </div>
    </div>
</div>
                
                <!-- Filters and Search -->
                <div class="y2k-paper p-3 mb-4">
                    <div class="row">
                        <div class="col-md-3 mb-3 mb-md-0">
                            <select class="form-select" id="statusFilter">
                                <option value="">All Status</option>
                                <option value="Pending Payment">Pending Payment</option>
                                <option value="Payment Verification">Payment Verification</option>
                                <option value="Processing">Processing</option>
                                <option value="Shipped">Shipped</option>
                                <option value="Delivered">Delivered</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3 mb-md-0">
                            <select class="form-select" id="dateFilter">
                                <option value="">All Time</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3 mb-md-0">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Search by order ID or customer name...">
                                <button class="y2k-button" type="button" onclick="searchTransactions()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="y2k-button w-100" onclick="exportTransactions()">
                                <i class="fas fa-download me-2"></i> Export
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Transactions Table -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead style="text-align: center;">
                            <tr>
                                <th>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="selectAll">
                                        <label class="form-check-label" for="selectAll"></label>
                                    </div>
                                </th>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Products</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTableBody">
                            <!-- Dynamic content will be loaded here -->
                        </tbody>
                    </table>
                </div>

                <!-- Bulk Actions and Pagination -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mt-3 p-3" style="background: rgba(255, 255, 255, 0.1); border-radius: 10px;">
    <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center mb-3 mb-md-0">
        <select class="form-select me-0 me-sm-2 mb-2 mb-sm-0" id="bulkActionSelect" style="width: auto; min-width: 200px;">
            <option value="">Bulk Actions</option>
            <option value="verification">Mark as Payment Verification</option>
            <option value="processing">Mark as Processing</option>
            <option value="shipped">Mark as Shipped</option>
            <option value="delivered">Mark as Delivered</option>
            <option value="cancelled">Cancel Orders</option>
            <option value="export">Export Selected</option>
        </select>
        <button class="y2k-button" onclick="applyBulkAction()">Apply</button>
    </div>
    <nav aria-label="Transactions pagination" class="w-100 w-md-auto">
        <ul class="pagination justify-content-center justify-content-md-end mb-0">
            <li class="page-item" id="prevPage">
                <a class="page-link" href="#" onclick="changePage(-1)">Previous</a>
            </li>
            <li class="page-item active"><a class="page-link" href="#" id="currentPageNum">1</a></li>
            <li class="page-item" id="nextPage">
                <a class="page-link" href="#" onclick="changePage(1)">Next</a>
            </li>
        </ul>
    </nav>
</div>
            </div>
        </div>
    </div>
</div>

<!-- View Order Modal -->
<div class="modal fade" id="viewOrderModal" tabindex="-1" aria-labelledby="viewOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewOrderModalLabel">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="orderDetailsBody">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="updateOrderStatusBtn">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1" aria-labelledby="updateStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="updateStatusModalLabel">Update Order Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <div class="mb-3">
                        <label for="newStatus" class="form-label">New Status</label>
                        <select class="form-select" id="newStatus" required>
                            <option value="">Select Status</option>
                            <option value="Payment Verification">Payment Verification</option>
                            <option value="Processing">Processing</option>
                            <option value="Shipped">Shipped</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="statusNote" class="form-label">Note (Optional)</label>
                        <textarea class="form-control" id="statusNote" rows="3" placeholder="Add a note about this status change..."></textarea>
                    </div>
                    <input type="hidden" id="orderIdToUpdate">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmStatusUpdate()">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 1;
    let itemsPerPage = 10;
    let allTransactions = [];
    let filteredTransactions = [];
    let selectedOrders = new Set();

    document.addEventListener('DOMContentLoaded', function() {
        // Check admin authentication
        checkAdminAuth();
        
        // Load admin profile
        loadAdminProfile();
        
        // Load transactions
        loadTransactions();
        
        // Setup event listeners
        setupEventListeners();
        
        // Setup sidebar toggle
        setupSidebarToggle();
    });

    function checkAdminAuth() {
        const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        
        if (!isLoggedIn || currentUser.role !== 'admin') {
            alert('Access denied. Admin privileges required.');
            window.location.href = 'login.html';
            return;
        }
    }

    // Load Admin Profile Data
function loadAdminProfile() {
    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
    
    if (currentUser && currentUser.name) {
        document.getElementById('admin-name').textContent = currentUser.name;
        const role = currentUser.role || 'user';
        document.getElementById('admin-role').textContent = role.charAt(0).toUpperCase() + role.slice(1);
        const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=4a90e2&color=ffffff&size=40&font-size=0.6&rounded=true&bold=true`;
        document.getElementById('admin-avatar').src = avatarUrl;
        document.getElementById('admin-avatar').alt = currentUser.name;
    } else {
        document.getElementById('admin-name').textContent = 'Admin User';
        document.getElementById('admin-role').textContent = 'Admin';
    }
    }

    function setupEventListeners() {
        // Filter and search listeners
        document.getElementById('statusFilter').addEventListener('change', filterTransactions);
        document.getElementById('dateFilter').addEventListener('change', filterTransactions);
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                searchTransactions();
            }
        });
        
        // Select all checkbox
        document.getElementById('selectAll').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = this.checked;
                if (this.checked) {
                    selectedOrders.add(checkbox.value);
                } else {
                    selectedOrders.delete(checkbox.value);
                }
            });
        });
    }

    function setupSidebarToggle() {
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.querySelector('.admin-sidebar');
        
        if (sidebarToggle && sidebar) {
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
            });
        }
    }

    function loadTransactions() {
        // Load all transactions from localStorage
        allTransactions = JSON.parse(localStorage.getItem('allTransactions')) || [];
        
        // If no transactions exist, create some sample data
        if (allTransactions.length === 0) {
            createSampleTransactions();
        }
        
        filteredTransactions = [...allTransactions];
        updateStats();
        displayTransactions();
    }

    function createSampleTransactions() {
        const sampleTransactions = [
            {
                id: "KP" + Date.now() + "001",
                userId: "user1",
                userName: "John Doe",
                userEmail: "john@example.com",
                userPhone: "+62 812-3456-7890",
                date: new Date().toISOString(),
                status: "Pending Payment",
                paymentDeadline: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                paymentMethod: "Bank Transfer",
                items: [
                    {
                        id: "1",
                        name: "BTS Lightstick Ver. 4",
                        image: "https://i.pinimg.com/736x/82/48/7b/82487b796956e9d1a382f7a1525a474b.jpg",
                        price: 799000,
                        quantity: 1
                    }
                ],
                subtotal: 799000,
                shipping: 25000,
                tax: 79900,
                total: 799000,
                finalTotal: 903900,
                shippingAddress: "Jl. Sudirman No. 123, Jakarta Pusat, DKI Jakarta 10110, Indonesia",
                paymentStatus: "Pending"
            },
            {
                id: "KP" + (Date.now() - 86400000) + "002",
                userId: "user2",
                userName: "Jane Smith",
                userEmail: "jane@example.com",
                userPhone: "+62 812-9876-5432",
                date: new Date(Date.now() - 86400000).toISOString(),
                status: "Delivered",
                items: [
                    {
                        id: "2",
                        name: "BLACKPINK - BORN PINK Album",
                        image: "https://i.pinimg.com/736x/76/ff/98/76ff98744be4647361e6ab64361c39ed.jpg",
                        price: 450000,
                        quantity: 1
                    }
                ],
                subtotal: 450000,
                shipping: 30000,
                tax: 45000,
                total: 450000,
                finalTotal: 525000,
                shippingAddress: "Jl. Thamrin No. 456, Jakarta Pusat, DKI Jakarta 10230, Indonesia",
                paymentMethod: "Credit Card",
                paymentStatus: "Paid"
            }
        ];
        
        localStorage.setItem('allTransactions', JSON.stringify(sampleTransactions));
        allTransactions = sampleTransactions;
    }

    function updateStats() {
        const totalOrders = allTransactions.length;
        const totalRevenue = allTransactions
            .filter(t => t.status === 'Delivered')
            .reduce((sum, t) => sum + (t.finalTotal || t.total), 0);
        const pendingOrders = allTransactions.filter(t => t.status === 'Pending Payment').length;
        const completedOrders = allTransactions.filter(t => t.status === 'Delivered').length;

        document.getElementById('total-orders').textContent = totalOrders;
        document.getElementById('total-revenue').textContent = 'Rp ' + formatPrice(totalRevenue);
        document.getElementById('pending-orders').textContent = pendingOrders;
        document.getElementById('completed-orders').textContent = completedOrders;
    }

    function displayTransactions() {
        const tbody = document.getElementById('transactionsTableBody');
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const pageTransactions = filteredTransactions.slice(startIndex, endIndex);

        if (pageTransactions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No transactions found</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = pageTransactions.map(transaction => `
            <tr>
                <td>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${transaction.id}" 
                               onchange="toggleOrderSelection('${transaction.id}')">
                    </div>
                </td>
                <td>
                    <strong>#${transaction.id}</strong>
                </td>
                <td>
                    <div>
                        <strong>${transaction.userName}</strong><br>
                        <small class="text-muted">${transaction.userEmail}</small>
                    </div>
                </td>
                <td>
                    <div class="d-flex align-items-center">
                        <img src="${transaction.items[0].image}" alt="${transaction.items[0].name}" 
                             style="width: 40px; height: 40px; object-fit: cover; border-radius: 5px; margin-right: 10px;">
                        <div>
                            <small><strong>${transaction.items[0].name}</strong></small>
                            ${transaction.items.length > 1 ? `<br><small class="text-muted">+${transaction.items.length - 1} more items</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>
                    <strong>Rp ${formatPrice(transaction.finalTotal || transaction.total)}</strong>
                </td>
                <td>
                    <span class="badge ${getStatusBadgeClass(transaction.status)}">${transaction.status}</span>
                </td>
                <td>
                    <small>${formatDate(transaction.date)}</small>
                </td>
                <td>
                    <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" onclick="viewOrder('${transaction.id}')" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="updateOrderStatus('${transaction.id}')" title="Update Status">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${transaction.status === 'Cancelled' ? '' : `
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelOrder('${transaction.id}')" title="Cancel Order">
                                <i class="fas fa-times"></i>
                            </button>
                        `}
                    </div>
                </td>
            </tr>
        `).join('');

        updatePagination();
    }

    function getStatusBadgeClass(status) {
        switch(status) {
            case 'Pending Payment': return 'bg-warning text-dark';
            case 'Payment Verification': return 'bg-info text-white';
            case 'Processing': return 'bg-primary text-white';
            case 'Shipped': return 'bg-secondary text-white';
            case 'Delivered': return 'bg-success text-white';
            case 'Cancelled': return 'bg-danger text-white';
            default: return 'bg-secondary text-white';
        }
    }

    function filterTransactions() {
        const statusFilter = document.getElementById('statusFilter').value;
        const dateFilter = document.getElementById('dateFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        filteredTransactions = allTransactions.filter(transaction => {
            // Status filter
            if (statusFilter && transaction.status !== statusFilter) return false;
            
            // Date filter
            if (dateFilter) {
                const transactionDate = new Date(transaction.date);
                const now = new Date();
                
                switch(dateFilter) {
                    case 'today':
                        if (transactionDate.toDateString() !== now.toDateString()) return false;
                        break;
                    case 'week':
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        if (transactionDate < weekAgo) return false;
                        break;
                    case 'month':
                        if (transactionDate.getMonth() !== now.getMonth() || 
                            transactionDate.getFullYear() !== now.getFullYear()) return false;
                        break;
                    case 'year':
                        if (transactionDate.getFullYear() !== now.getFullYear()) return false;
                        break;
                }
            }
            
            // Search filter
            if (searchTerm) {
                const searchInId = transaction.id.toLowerCase().includes(searchTerm);
                const searchInName = transaction.userName.toLowerCase().includes(searchTerm);
                const searchInEmail = transaction.userEmail.toLowerCase().includes(searchTerm);
                if (!searchInId && !searchInName && !searchInEmail) return false;
            }
            
            return true;
        });

        currentPage = 1;
        displayTransactions();
    }

    function searchTransactions() {
        filterTransactions();
    }

    function toggleOrderSelection(orderId) {
        if (selectedOrders.has(orderId)) {
            selectedOrders.delete(orderId);
        } else {
            selectedOrders.add(orderId);
        }
    }

    function viewOrder(orderId) {
        const transaction = allTransactions.find(t => t.id === orderId);
        if (!transaction) return;

        const modalBody = document.getElementById('orderDetailsBody');
        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">Order Information</h6>
                    <p><strong>Order ID:</strong> #${transaction.id}</p>
                    <p><strong>Date:</strong> ${formatDateTime(transaction.date)}</p>
                    <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(transaction.status)}">${transaction.status}</span></p>
                    <p><strong>Payment Method:</strong> ${transaction.paymentMethod || 'N/A'}</p>
                    ${transaction.paymentDeadline ? `<p><strong>Payment Deadline:</strong> ${formatDateTime(transaction.paymentDeadline)}</p>` : ''}
                </div>
                <div class="col-md-6">
                    <h6 class="fw-bold mb-3">Customer Information</h6>
                    <p><strong>Name:</strong> ${transaction.userName}</p>
                    <p><strong>Email:</strong> ${transaction.userEmail}</p>
                    <p><strong>Phone:</strong> ${transaction.userPhone || 'N/A'}</p>
                    <p><strong>Address:</strong> ${transaction.shippingAddress || 'N/A'}</p>
                </div>
            </div>
            <hr>
            <h6 class="fw-bold mb-3">Order Items</h6>
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${transaction.items.map(item => `
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="${item.image}" alt="${item.name}" style="width: 30px; height: 30px; object-fit: cover; border-radius: 3px; margin-right: 8px;">
                                        <span>${item.name}</span>
                                    </div>
                                </td>
                                <td>${item.quantity}</td>
                                <td>Rp ${formatPrice(item.price)}</td>
                                <td>Rp ${formatPrice(item.price * item.quantity)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            <hr>
            <div class="row">
                <div class="col-md-6 offset-md-6">
                    <table class="table table-sm">
                        <tr>
                            <td>Subtotal:</td>
                            <td class="text-end">Rp ${formatPrice(transaction.subtotal || transaction.total)}</td>
                        </tr>
                        <tr>
                            <td>Shipping:</td>
                            <td class="text-end">Rp ${formatPrice(transaction.shipping || 0)}</td>
                        </tr>
                        <tr>
                            <td>Tax:</td>
                            <td class="text-end">Rp ${formatPrice(transaction.tax || 0)}</td>
                        </tr>
                        <tr class="fw-bold">
                            <td>Total:</td>
                            <td class="text-end">Rp ${formatPrice(transaction.finalTotal || transaction.total)}</td>
                        </tr>
                    </table>
                </div>
            </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('viewOrderModal'));
        modal.show();
    }

    function updateOrderStatus(orderId) {
        document.getElementById('orderIdToUpdate').value = orderId;
        const modal = new bootstrap.Modal(document.getElementById('updateStatusModal'));
        modal.show();
    }

    function confirmStatusUpdate() {
        const orderId = document.getElementById('orderIdToUpdate').value;
        const newStatus = document.getElementById('newStatus').value;
        const note = document.getElementById('statusNote').value;

        if (!newStatus) {
            alert('Please select a status');
            return;
        }

        // Update in allTransactions
        const transactionIndex = allTransactions.findIndex(t => t.id === orderId);
        if (transactionIndex !== -1) {
            allTransactions[transactionIndex].status = newStatus;
            allTransactions[transactionIndex].lastUpdated = new Date().toISOString();
            if (note) {
                allTransactions[transactionIndex].adminNote = note;
            }
            
            // Save to localStorage
            localStorage.setItem('allTransactions', JSON.stringify(allTransactions));
            
            // Update user's transaction history
            const transaction = allTransactions[transactionIndex];
            if (transaction.userId) {
                const userTransactionKey = `userTransactions_${transaction.userId}`;
                const userTransactions = JSON.parse(localStorage.getItem(userTransactionKey)) || [];
                const userTransactionIndex = userTransactions.findIndex(t => t.id === orderId);
                
                if (userTransactionIndex !== -1) {
                    userTransactions[userTransactionIndex].status = newStatus;
                    userTransactions[userTransactionIndex].lastUpdated = new Date().toISOString();
                    if (note) {
                        userTransactions[userTransactionIndex].adminNote = note;
                    }
                    localStorage.setItem(userTransactionKey, JSON.stringify(userTransactions));
                }
            }
            
            // Refresh display
            loadTransactions();
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('updateStatusModal'));
            modal.hide();
            
            // Reset form
            document.getElementById('updateStatusForm').reset();
            
            showAlert(`Order #${orderId} status updated to ${newStatus}`, 'success');
        }
    }

    function cancelOrder(orderId) {
        if (!confirm('Are you sure you want to cancel this order?')) return;
        
        const transactionIndex = allTransactions.findIndex(t => t.id === orderId);
        if (transactionIndex !== -1) {
            allTransactions[transactionIndex].status = 'Cancelled';
            allTransactions[transactionIndex].cancelledAt = new Date().toISOString();
            allTransactions[transactionIndex].cancellationReason = 'Cancelled by admin';
            
            localStorage.setItem('allTransactions', JSON.stringify(allTransactions));
            
            // Update user's transaction history
            const transaction = allTransactions[transactionIndex];
            if (transaction.userId) {
                const userTransactionKey = `userTransactions_${transaction.userId}`;
                const userTransactions = JSON.parse(localStorage.getItem(userTransactionKey)) || [];
                const userTransactionIndex = userTransactions.findIndex(t => t.id === orderId);
                
                if (userTransactionIndex !== -1) {
                    userTransactions[userTransactionIndex].status = 'Cancelled';
                    userTransactions[userTransactionIndex].cancelledAt = new Date().toISOString();
                    userTransactions[userTransactionIndex].cancellationReason = 'Cancelled by admin';
                    localStorage.setItem(userTransactionKey, JSON.stringify(userTransactions));
                }
            }
            
            loadTransactions();
            showAlert(`Order #${orderId} has been cancelled`, 'success');
        }
    }

    function applyBulkAction() {
        const action = document.getElementById('bulkActionSelect').value;
        if (!action || selectedOrders.size === 0) {
            alert('Please select an action and at least one order');
            return;
        }

        if (!confirm(`Apply ${action} to ${selectedOrders.size} selected orders?`)) return;

        selectedOrders.forEach(orderId => {
            const transactionIndex = allTransactions.findIndex(t => t.id === orderId);
            if (transactionIndex !== -1) {
                switch(action) {
                    case 'verification':
                        allTransactions[transactionIndex].status = 'Payment Verification';
                        break;
                    case 'processing':
                        allTransactions[transactionIndex].status = 'Processing';
                        break;
                    case 'shipped':
                        allTransactions[transactionIndex].status = 'Shipped';
                        break;
                    case 'delivered':
                        allTransactions[transactionIndex].status = 'Delivered';
                        break;
                    case 'cancelled':
                        allTransactions[transactionIndex].status = 'Cancelled';
                        allTransactions[transactionIndex].cancelledAt = new Date().toISOString();
                        allTransactions[transactionIndex].cancellationReason = 'Bulk cancelled by admin';
                        break;
                }
                allTransactions[transactionIndex].lastUpdated = new Date().toISOString();
                
                // Update user's transaction history
                const transaction = allTransactions[transactionIndex];
                if (transaction.userId) {
                    const userTransactionKey = `userTransactions_${transaction.userId}`;
                    const userTransactions = JSON.parse(localStorage.getItem(userTransactionKey)) || [];
                    const userTransactionIndex = userTransactions.findIndex(t => t.id === orderId);
                    
                    if (userTransactionIndex !== -1) {
                        userTransactions[userTransactionIndex].status = allTransactions[transactionIndex].status;
                        userTransactions[userTransactionIndex].lastUpdated = new Date().toISOString();
                        if (action === 'cancelled') {
                            userTransactions[userTransactionIndex].cancelledAt = new Date().toISOString();
                            userTransactions[userTransactionIndex].cancellationReason = 'Bulk cancelled by admin';
                        }
                        localStorage.setItem(userTransactionKey, JSON.stringify(userTransactions));
                    }
                }
            }
        });

        localStorage.setItem('allTransactions', JSON.stringify(allTransactions));
        
        // Clear selections
        selectedOrders.clear();
        document.getElementById('selectAll').checked = false;
        document.getElementById('bulkActionSelect').value = '';
        
        loadTransactions();
        showAlert(`Bulk action applied to ${selectedOrders.size} orders`, 'success');
    }

    function exportTransactions() {
        const dataToExport = selectedOrders.size > 0 
            ? allTransactions.filter(t => selectedOrders.has(t.id))
            : filteredTransactions;
            
        const csvContent = convertToCSV(dataToExport);
        downloadCSV(csvContent, 'transactions.csv');
    }

    function convertToCSV(data) {
        const headers = ['Order ID', 'Customer Name', 'Email', 'Status', 'Total', 'Date'];
        const rows = data.map(t => [
            t.id,
            t.userName,
            t.userEmail,
            t.status,
            t.finalTotal || t.total,
            formatDate(t.date)
        ]);
        
        return [headers, ...rows].map(row => row.join(',')).join('\n');
    }

    function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function changePage(direction) {
        const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
        const newPage = currentPage + direction;
        
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            displayTransactions();
        }
    }

    function updatePagination() {
        const totalPages = Math.ceil(filteredTransactions.length / itemsPerPage);
        document.getElementById('currentPageNum').textContent = currentPage;
        
        document.getElementById('prevPage').classList.toggle('disabled', currentPage === 1);
        document.getElementById('nextPage').classList.toggle('disabled', currentPage === totalPages);
    }

    function formatPrice(price) {
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('id-ID', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function formatDateTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('id-ID', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function showAlert(message, type = 'info') {
        const alertTypes = {
            'success': 'alert-success',
            'error': 'alert-danger',
            'info': 'alert-info',
            'warning': 'alert-warning'
        };
        
        const alertClass = alertTypes[type] || 'alert-info';
        const alertHTML = `
            <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
                 style="top: 100px; right: 20px; z-index: 9999; min-width: 350px;" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;

        document.querySelectorAll('.alert').forEach(alert => alert.remove());
        document.body.insertAdjacentHTML('beforeend', alertHTML);

        setTimeout(() => {
            const alert = document.querySelector('.alert');
            if (alert) alert.remove();
        }, 5000);
    }

// Mobile responsiveness improvements
function handleMobileLayout() {
    const isMobile = window.innerWidth <= 768;
    const bulkActionContainer = document.querySelector('.d-flex.flex-column.flex-md-row');
    
    if (isMobile) {
        // Ensure proper mobile layout
        bulkActionContainer.classList.add('mobile-layout');
    } else {
        bulkActionContainer.classList.remove('mobile-layout');
    }
}

// Add resize listener
window.addEventListener('resize', handleMobileLayout);

// Call on page load
document.addEventListener('DOMContentLoaded', function() {
    handleMobileLayout();
    // ... existing DOMContentLoaded code
});
</script>
</body>
</html>
